{% load static  %}
<!doctype html>
<html lang='en'>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>FIR - TrafficIQ</title>
  <link href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css' rel='stylesheet'>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'></script>
  <style>
    body {
      background: #0b0c10;
      color: #fff;
    }
    .card-glass {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      backdrop-filter: blur(8px);
      box-shadow: 0 0 10px rgba(255,255,255,0.2);
    }
    .btn-ti {
      background: #00c6ff;
      color: #000;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class='container py-4'>
    <h3>üöî File FIR</h3>
    <div class='card card-glass p-3'>
      <form id='firForm' onsubmit='submitFIRForm(event)' method="POST">
        {% csrf_token %}
        <div class='input-group mb-2'>
          <input id='fir_location' placeholder='lat,lon (auto)' class='form-control'>
          <button type='button' class='btn btn-outline-light' onclick='getLocationForFIR()'>üìç Use My Location</button>
        </div>
        <div id='fir_location_status' class='small text-muted mb-2'></div>
        <textarea id='fir_desc' class='form-control mb-2' placeholder='Describe incident'></textarea>

        <div class='mb-2'>
          <button type='button' class='btn btn-outline-light me-2' onclick='document.getElementById("fir_file").click()'>üì∏ Upload Image</button>
          <input type='file' id='fir_file' accept='image/*' class='form-control d-inline-block' style='width:auto; display:none'
          onchange="(function(e){ const fr=new FileReader(); fr.onload=function(){ document.getElementById('cameraPreview').src=fr.result; document.getElementById('fir_camera_image').value=fr.result; }; fr.readAsDataURL(e.target.files[0]); })(event)">
        </div>

        <input type='hidden' id='fir_camera_image' />
        <div><img id='cameraPreview' src='' style='max-width:240px; border-radius:8px; background:#111' /></div>
        <button class='btn btn-ti mt-3'>Submit FIR</button>
      </form>
      <div id='fir_submit_status' class='mt-3 small text-success'></div>
    </div>
  </div>

  <!-- Popup Modal -->
  <div class="modal fade" id="firModal" tabindex="-1" aria-labelledby="firModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-dark">
        <div class="modal-header">
          <h5 class="modal-title" id="firModalLabel">‚úÖ FIR Submitted</h5>
        </div>
        <div class="modal-body">
          Your FIR has been successfully filed at your nearest police station.<br>
          A demo PDF report will now be generated.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <script src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js'></script>
  {% comment %} <script>
    function getLocationForFIR() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          const coords = pos.coords.latitude + "," + pos.coords.longitude;
          document.getElementById('fir_location').value = coords;
          document.getElementById('fir_location_status').innerText = "Location detected ‚úÖ";
        });
      } else {
        document.getElementById('fir_location_status').innerText = "Geolocation not supported!";
      }
    }

    async function submitFIRForm(e) {
      e.preventDefault();
      const location = document.getElementById('fir_location').value;
      const desc = document.getElementById('fir_desc').value;
      const img = document.getElementById('fir_camera_image').value;

      if (!desc.trim()) {
        alert("Please describe the incident.");
        return;
      }

      // Show popup
      const modal = new bootstrap.Modal(document.getElementById('firModal'));
      modal.show();

      // Generate demo PDF
      setTimeout(() => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(16);
        doc.text("TrafficIQ - FIR Report", 70, 20);
        doc.setFontSize(12);
        doc.text("Date: " + new Date().toLocaleString(), 20, 35);
        doc.text("Location: " + (location || "Not provided"), 20, 45);
        doc.text("Description:", 20, 55);
        doc.text(desc, 20, 65, { maxWidth: 170 });

        if (img) {
          doc.addImage(img, "JPEG", 20, 110, 60, 60);
        }

        doc.save("FIR_Report.pdf");
        document.getElementById('fir_submit_status').innerText = "FIR submitted successfully ‚úÖ";
      }, 2000);
    }
  </script> {% endcomment %}
</body>
</html>
